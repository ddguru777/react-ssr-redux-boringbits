{"version":3,"sources":["../../../src/lib/init-routers/index.js"],"names":["compose","require","module","exports","initRoutes","BoringInjections","boring","decorators","endpoint_meta","on","eventData","metadata","router","getMetaDataByClass","target","push","subscribeDecorators","instances","injecture","allInstances","forEach","Klass","moduleData","paths","boring_routers","server_routers","route_descriptors","concat","Object","keys","map","name","route","endpoints","endpoint","methods","method","wrapHandler","noop","req","res","next","getMiddlewareFunc","middleware","middlewareStack","runStack","func","args","curryWrapper","handler","wrappedHandler","ctx","perform","toLowerCase","Promise","resolve","reject","err","then","call","catch","e","logger","error"],"mappings":"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","sourcesContent":["import paths from 'paths';\r\nimport requireInject from 'require-inject-all';\r\nimport logger from 'boring-logger'\r\nimport endpoint_transformer from './transform-annotation'\r\n//import * as decorators from '../decorators'\r\nimport injecture from 'injecture'\r\nconst compose = require('compose-middleware').compose\r\n\r\n\r\nmodule.exports = async function initRoutes(BoringInjections) {\r\n\r\n  const {\r\n    boring\r\n  } = BoringInjections;\r\n\r\n  const decorators = boring.decorators;\r\n  \r\n  const endpoint_meta = [];\r\n\r\n  /**\r\n   * !IMPORTANT!\r\n   * \r\n   * First, we *must* subscribe the decorators to boring's \r\n   * event emitter.  This way we will know all the classes\r\n   * used by the @endpoint decorator.  THEN we can \r\n   * use requireInject to actually require the files \r\n   */\r\n  boring.on('decorator.router.endpoint', function(eventData){\r\n    \r\n    const metadata= decorators.router.getMetaDataByClass(eventData.target).metadata\r\n    endpoint_meta.push(endpoint_transformer(metadata));\r\n  });\r\n  boring.decorators.subscribeDecorators(boring);\r\n\r\n  /**\r\n   * Now we just took care of any future enpoints, \r\n   * let's grab all of the endpoints defined before \r\n   * this point in the boot sequence, such as middleware\r\n   */\r\n  const instances = injecture.allInstances('decorator.router.endpoint');\r\n\r\n  instances.forEach(Klass => {\r\n    const metadata= decorators.router.getMetaDataByClass(Klass).metadata\r\n    endpoint_meta.push(endpoint_transformer(metadata));\r\n  });\r\n\r\n  \r\n  let moduleData =await requireInject([paths.boring_routers, paths.server_routers], boring)\r\n\r\n  const route_descriptors = endpoint_meta.concat(Object.keys(moduleData).map(name => {\r\n  \r\n    const route = moduleData[name] || { endpoints: []};\r\n    //If the route does not already have a name\r\n    //then use the name of the module.  This object.name\r\n    //will be added to the route_meta array \r\n    //and NOT guranteed to be unique.  The name\r\n    //serves simply as an identifier in logging\r\n    if (!route.name) route.name = name;\r\n\r\n    return route;\r\n  }));\r\n\r\n  route_descriptors.forEach(route => {\r\n\r\n    route.endpoints.forEach(endpoint => {\r\n\r\n      const methods = endpoint.methods || {};\r\n      Object.keys(methods).forEach(method => {\r\n        wrapHandler(boring, route, endpoint, methods, method);\r\n      });\r\n\r\n    });\r\n\r\n  })\r\n\r\n  return route_descriptors;\r\n}\r\n\r\nfunction noop(req, res, next) {\r\n  next();\r\n}\r\n\r\nfunction getMiddlewareFunc(boring, middleware) {\r\n  if (typeof middleware === 'string') {\r\n    return boring.middleware[middleware] || noop;\r\n  }\r\n  \r\n  if (typeof middleware === 'function') {\r\n    return middleware;\r\n  }\r\n}\r\n\r\n// this is extracted from the code\r\n// below to not enclose all the objects \r\n// within initRoutes.  These handlers \r\n// will be wrapped and always in the heap\r\nfunction wrapHandler(boring, route, endpoint, methods, method) {\r\n\r\n  // first, normalize the middleware\r\n  let middlewareStack = endpoint.middleware || [];\r\n  if (typeof endpoint.middleware === 'function') {\r\n    middlewareStack = [middlewareStack];\r\n  }\r\n\r\n  const runStack = compose(middlewareStack.map(middleware => {\r\n    \r\n    let func = getMiddlewareFunc(boring, middleware);\r\n    if (func) return func;\r\n\r\n    if (middleware && middleware.args) {\r\n      func = getMiddlewareFunc(boring, middleware.func);\r\n      return function curryWrapper(req, res, next) {\r\n        func(req, res, next, middleware.args);\r\n      };\r\n    }\r\n\r\n  }));\r\n\r\n  \r\n  // normalize data structure to match\r\n  // decorator API\r\n  if (typeof methods[method] === 'function') {\r\n    const func = methods[method];\r\n    methods[method] = {\r\n      handler: func\r\n    }\r\n  }\r\n  \r\n  const handler = methods[method].handler;\r\n  methods[method].handler = function wrappedHandler(req, res, next) {\r\n    const ctx = {\r\n      req, \r\n      res, \r\n      next, \r\n      route,\r\n      endpoint,\r\n      method\r\n    };\r\n    ctx[method] = methods[method];\r\n\r\n    // first execute the middleware\r\n    boring.perform(`http::${method.toLowerCase()}::middleware`, ctx, () => {\r\n\r\n      return new Promise(function(resolve, reject) {\r\n        runStack(ctx.req, ctx.res, function(err) {\r\n          if (err) return reject(err);\r\n          resolve(ctx);\r\n        });\r\n        \r\n      });\r\n    })\r\n    .then(() => {\r\n      // then execte handler\r\n      boring.perform('http::'+method.toLowerCase(), ctx, async function() {\r\n        handler.call(this, ctx.req, ctx.res, ctx.next);\r\n        return ctx;\r\n      }).catch(e => {\r\n        logger.error(e, 'There was a critical error thrown in the handler stack, rethrowing to express');\r\n        throw e;\r\n      });\r\n\r\n    })\r\n    .catch(e => {\r\n      logger.error(e, 'There was a critical error thrown in the handler stack, rethrowing to express');\r\n      throw e;\r\n    })\r\n\r\n\r\n  };\r\n\r\n}"],"file":"index.js"}