{"version":3,"sources":["../../../../src/lib/init-routers/test/init-endpoints-test.js"],"names":["assert","require","proxyquire","noPreserveCache","logger","Emitter","decorators","Understudy","noop","findByName","arr","name","i","length","undefined","wipeInjectoreStore","jectureStore","jecture_keys","Object","keys","forEach","key","stored","instances","describe","timeout","mockRequireAll","dataToMock","Promise","resolve","afterEach","it","done","init","path","endpoints","methods","get","post","head","Boring","constructor","call","app","boring","then","result","pageA","pageB","pageC","equal","wildcard","endpoint","router","calls","Stuff","serveFoo","push","meep","handler","notEqual","setImmediate","foo","before","ctx","setTimeout"],"mappings":"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","sourcesContent":["const assert = require('assert');\r\nconst proxyquire = require('proxyquire').noPreserveCache();\r\nconst logger = require('boring-logger');\r\nconst Emitter = require('eventemitter2');\r\nconst decorators = require('../../decorators')\r\nconst Understudy = require('boring-understudy')\r\n\r\nconst noop = function() {}\r\n\r\nfunction findByName(arr, name) {\r\n  for (var i=0; i<arr.length; i++) {\r\n    if (arr[i].name === name) return arr[i];\r\n  }\r\n  return undefined;\r\n}\r\n\r\nfunction wipeInjectoreStore() {\r\n  \r\n  const jectureStore = require('injecture/injecture-store');\r\n  const jecture_keys = Object.keys(jectureStore);\r\n  jecture_keys.forEach(key => {\r\n    const stored = jectureStore[key]\r\n    stored.instances = {};\r\n  });\r\n\r\n}\r\n\r\ndescribe('Init Endpoints', function() {\r\n\r\n  this.timeout(7000)\r\n\r\n  function mockRequireAll(dataToMock) {\r\n\r\n    wipeInjectoreStore()\r\n\r\n    return proxyquire('../index', {\r\n      'require-inject-all': function() {\r\n        return new Promise((resolve) => {\r\n          resolve(dataToMock);\r\n        });\r\n      },\r\n    })\r\n  }\r\n\r\n  afterEach(function() {\r\n    wipeInjectoreStore();\r\n  })\r\n \r\n\r\n  it('will install endpoint verbs from JSON', function(done) {\r\n\r\n    const init = mockRequireAll({\r\n      \"pageA\": {\r\n        path: '/meow',\r\n        endpoints: [\r\n          {\r\n            path: '/foo',\r\n            methods: {\r\n              get: noop\r\n            }\r\n          }\r\n        ]\r\n      },\r\n      \"pageB\": {\r\n        endpoints: [\r\n          {\r\n            path: '/beep',\r\n            methods: {\r\n              post: noop,\r\n              head: noop\r\n            }\r\n          }\r\n        ]\r\n      },\r\n      \"pageC\": undefined\r\n    })\r\n    \r\n    class Boring extends Emitter {\r\n      constructor() {\r\n        super({});\r\n        Understudy.call(this);\r\n        this.app = {};\r\n        this.decorators = decorators;\r\n\r\n      }\r\n    }\r\n\r\n    const boring = new Boring();\r\n\r\n    init({boring}).then(result => {\r\n\r\n      const pageA = findByName(result, 'pageA');\r\n      const pageB = findByName(result, 'pageB');\r\n      const pageC = findByName(result, 'pageC');\r\n\r\n      assert.equal(Object.keys(pageA.endpoints[0].methods).length, 1);\r\n      assert.equal(Object.keys(pageB.endpoints[0].methods).length, 2);\r\n      \r\n      assert.equal(pageC.endpoints.length, 0);\r\n      \r\n      done();\r\n    })\r\n  });\r\n\r\n  it('will install endpoint verbs from annotation', done => {\r\n\r\n    const init = mockRequireAll({});\r\n    \r\n    class Boring extends Emitter {\r\n      constructor() {\r\n        super({wildcard: true});\r\n        Understudy.call(this);\r\n        this.app = {};\r\n        this.decorators = decorators;\r\n      }\r\n    }\r\n\r\n    const boring = new Boring();\r\n    \r\n    const { \r\n      endpoint,\r\n      get\r\n    }= decorators.router;\r\n\r\n    const calls = [];\r\n\r\n    // this is to simply fire the \r\n    // event decorator.router.endpoint\r\n    @endpoint('/meow')\r\n    class Stuff {\r\n\r\n      @get('/beep')\r\n      serveFoo() {\r\n        calls.push('meat')\r\n      }\r\n\r\n      @get('/guz')\r\n      meep() {\r\n        calls.push('meep')\r\n      }\r\n    }\r\n\r\n    init({boring}).then(result => {\r\n      assert.equal(result.length, 1);\r\n      assert.equal(result[0].endpoints.length, 2, 'There should be two endpoints');\r\n      assert.equal(result[0].endpoints[0].path, '/beep');\r\n      result[0].endpoints[0].methods.get.handler();\r\n\r\n      assert.notEqual(calls[0], 'meat', 'serveFoo is not executed sync due to some promises in the middle of the chain');\r\n\r\n      setImmediate(() => {\r\n\r\n        assert.equal(calls[0], 'meat', 'serveFoo was not executed');\r\n\r\n        assert.equal(result[0].endpoints[1].path, '/guz');\r\n        result[0].endpoints[1].methods.get.handler();\r\n        \r\n        setImmediate(() => {\r\n          assert.equal(calls[1], 'meep');\r\n        \r\n          done();\r\n        });\r\n      });\r\n    })\r\n\r\n  });\r\n\r\n\r\n  it('should allow a hook to pause the handler', done => {\r\n\r\n    const init = mockRequireAll({});\r\n    \r\n    class Boring extends Emitter {\r\n      constructor() {\r\n        super({wildcard: true});\r\n        Understudy.call(this);\r\n        this.app = {};\r\n        this.decorators = decorators;\r\n\r\n      }\r\n    }\r\n\r\n    const boring = new Boring();\r\n    \r\n    const { \r\n      endpoint,\r\n      get\r\n    }= decorators.router;\r\n\r\n    const calls = [];\r\n\r\n    @endpoint()\r\n    class Stuff {\r\n\r\n      @get('/foo')\r\n      foo() {\r\n        calls.push('matt')\r\n      }\r\n\r\n    }\r\n\r\n    init({boring}).then(result => {\r\n\r\n      boring.before('http::get', function(ctx) {\r\n        return new Promise(resolve => {\r\n          setTimeout(resolve, 100);\r\n        })\r\n      });\r\n\r\n      result[0].endpoints[0].methods.get.handler();\r\n      assert.equal(calls.length, 0);\r\n\r\n      //check once\r\n      setTimeout(function() {\r\n        assert.equal(calls.length, 0);\r\n      }, 50);\r\n\r\n      //last check, this one should be set \r\n      setTimeout(function() {\r\n        assert.equal(calls[0], 'matt');\r\n        done();\r\n      }, 200);\r\n\r\n    })\r\n\r\n  });\r\n\r\n});"],"file":"init-endpoints-test.js"}