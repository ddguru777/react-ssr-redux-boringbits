{"version":3,"sources":["../../src/lib/init-pipeline.js"],"names":["config","require","express","initRouters","logger","initMiddleware","initHooks","EventEmitter","paths","Understudy","InitPipeline","constructor","wildcard","call","middleware","hooks","app","oldUse","use","perform","bind","name","ctx","deferMiddleware","Promise","resolve","reject","catch","add_middleware","Error","emit","add_hook","hook","add_router","router","routePath","path","endpoints","forEach","endpoint","methods","Object","keys","method","handler","info","toUpperCase","build","options","injections","assign","boring","routers","route","middlewarePromise","queuing","proxyMiddleware","req","res","next","url","then","deferedMiddleware","e","module","exports"],"mappings":";;AAAA,MAAMA,MAAM,GAAGC,OAAO,CAAC,eAAD,CAAtB;;AACA,MAAMC,OAAO,GAAGD,OAAO,CAAC,SAAD,CAAvB;;AACA,MAAME,WAAW,GAAGF,OAAO,CAAC,gBAAD,CAA3B;;AACA,MAAMG,MAAM,GAAGH,OAAO,CAAC,eAAD,CAAtB;;AACA,MAAMI,cAAc,GAAGJ,OAAO,CAAC,mBAAD,CAA9B;;AACA,MAAMK,SAAS,GAAGL,OAAO,CAAC,cAAD,CAAzB;;AACA,MAAMM,YAAY,GAAGN,OAAO,CAAC,eAAD,CAA5B;;AACA,MAAMO,KAAK,GAAGP,OAAO,CAAC,OAAD,CAArB;;AACA,MAAMQ,UAAU,GAAGR,OAAO,CAAC,mBAAD,CAA1B;;AAEA,MAAMS,YAAN,SAA2BH,YAA3B,CAAyC;AAEvCI,EAAAA,WAAW,GAAG;AACZ,UAAM;AAACC,MAAAA,QAAQ,EAAE;AAAX,KAAN;AACAH,IAAAA,UAAU,CAACI,IAAX,CAAgB,IAAhB;AACA,SAAKb,MAAL,GAAcA,MAAd;AACA,SAAKI,MAAL,GAAcA,MAAd;AACA,SAAKI,KAAL,GAAaA,KAAb;AAEA,SAAKM,UAAL,GAAkB,EAAlB;AACA,SAAKC,KAAL,GAAa,EAAb;AACA,SAAKC,GAAL,GAAWd,OAAO,EAAlB;AAEA,SAAKc,GAAL,CAASC,MAAT,GAAkB,KAAKD,GAAL,CAASE,GAA3B;AACA,UAAMC,OAAO,GAAG,KAAKA,OAAL,CAAaC,IAAb,CAAkB,IAAlB,CAAhB;;AAEA,SAAKJ,GAAL,CAASE,GAAT,GAAe,CAACG,IAAD,EAAOP,UAAP,KAAsB;AAEnC,UAAI,OAAOO,IAAP,KAAgB,UAApB,EAAgC;AAC9BP,QAAAA,UAAU,GAAGO,IAAb;AACAA,QAAAA,IAAI,GAAGP,UAAU,CAACO,IAAlB,CAF8B,CAEN;AACzB;;AAGD,UAAIC,GAAG,GAAG;AACRR,QAAAA,UADQ;AAERO,QAAAA,IAFQ,CAKV;;AALU,OAAV;AAOA,WAAKL,GAAL,CAASC,MAAT,CAAgBM,eAAe,CAAC,IAAIC,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AAEpEP,QAAAA,OAAO,CAAC,SAAD,EAAYG,GAAZ,EAAiB,kBAAiB;AACvC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACAG,UAAAA,OAAO,CAACH,GAAG,CAACR,UAAL,CAAP;AACA,iBAAOQ,GAAP;AACD,SAXM,CAAP,CAWGK,KAXH,CAWSD,MAXT;AAaD,OAf+B,CAAD,CAA/B;AAiBA,KAhCF;AAiCD;;AAEDE,EAAAA,cAAc,CAACP,IAAD,EAAOP,UAAP,EAAmB;AAC/B,QAAI,KAAKA,UAAL,CAAgBO,IAAhB,CAAJ,EAA2B,MAAM,IAAIQ,KAAJ,CAAU,gDAA+CR,IAAzD,CAAN;AAC3B,SAAKP,UAAL,CAAgBO,IAAhB,IAAwBP,UAAxB;AACA,SAAKgB,IAAL,CAAU,kBAAV,EAA8BT,IAA9B,EAAoCP,UAApC;AACD;;AAEDiB,EAAAA,QAAQ,CAACV,IAAD,EAAOW,IAAP,EAAa;AACnB,QAAI,KAAKjB,KAAL,CAAWM,IAAX,CAAJ,EAAsB,MAAM,IAAIQ,KAAJ,CAAU,0CAAyCR,IAAnD,CAAN;AACtB,SAAKN,KAAL,CAAWM,IAAX,IAAmBW,IAAnB;AACA,SAAKF,IAAL,CAAU,YAAV,EAAwBT,IAAxB,EAA8BW,IAA9B;AACD;;AAEDC,EAAAA,UAAU,CAACC,MAAD,EAAS;AAEjB,UAAMC,SAAS,GAAGD,MAAM,CAACE,IAAP,IAAe,EAAjC;AACA,UAAMpB,GAAG,GAAG,KAAKA,GAAjB;AAEAkB,IAAAA,MAAM,CAACG,SAAP,CAAiBC,OAAjB,CAAyB,CAACC,QAAQ,GAAG;AAACH,MAAAA,IAAI,EAAE,EAAP;AAAWI,MAAAA,OAAO,EAAE;AAApB,KAAZ,KAAwC;AAE/D;AACA,YAAMA,OAAO,GAAGD,QAAQ,CAACC,OAAT,IAAoB,EAApC;AACAC,MAAAA,MAAM,CAACC,IAAP,CAAYF,OAAZ,EAAqBF,OAArB,CAA6BK,MAAM,IAAI;AACrC,YAAIP,IAAI,GAAGD,SAAS,GAAGI,QAAQ,CAACH,IAAhC;AACA,YAAIQ,OAAO,GAAGL,QAAQ,CAACC,OAAT,CAAiBG,MAAjB,CAAd,CAFqC,CAGrC;AACA;AACA;;AACA,YAAIC,OAAO,CAACA,OAAZ,EAAqBA,OAAO,GAAGA,OAAO,CAACA,OAAlB;AAErB5B,QAAAA,GAAG,CAAC2B,MAAD,CAAH,CAAYP,IAAZ,EAAkBQ,OAAlB;AACAxC,QAAAA,MAAM,CAACyC,IAAP,CAAa,cAAaF,MAAM,CAACG,WAAP,EAAqB,cAAaV,IAAK,EAAjE;AACD,OAVD;AAYA,WAAKN,IAAL,CAAU,gBAAV,EAA4BS,QAA5B;AACD,KAjBD;AAmBD;;AAED,QAAMQ,KAAN,CAAYC,OAAZ,EAAqB;AAEnB,QAAIC,UAAU,GAAGR,MAAM,CAACS,MAAP,CAAc,EAAd,EAAkB;AACjCC,MAAAA,MAAM,EAAE;AADyB,KAAlB,EAEdH,OAFc,CAAjB;AAKA,UAAMjC,KAAK,GAAG,MAAM,KAAKI,OAAL,CAAa,YAAb,EAA2B8B,UAA3B,EAAuC,YAAY;AACrE,aAAO,MAAM3C,SAAS,CAAC2C,UAAD,CAAtB;AACD,KAFmB,CAApB;AAIAA,IAAAA,UAAU,CAAClC,KAAX,GAAmBA,KAAnB;AAEA,UAAM,KAAKI,OAAL,CAAa,WAAb,EAA0B8B,UAA1B,EAAsC,YAAW;AACrDR,MAAAA,MAAM,CAACC,IAAP,CAAYO,UAAU,CAAClC,KAAvB,EAA8BuB,OAA9B,CAAsCjB,IAAI,IAAI,KAAKU,QAAL,CAAcV,IAAd,EAAoB4B,UAAU,CAAClC,KAAX,CAAiBM,IAAjB,CAApB,CAA9C;AACA,aAAO4B,UAAP;AACD,KAHK,CAAN;AAKA,UAAMnC,UAAU,GAAG,MAAM,KAAKK,OAAL,CAAa,iBAAb,EAAgC8B,UAAhC,EAA4C,YAAY;AAC/E,aAAO,MAAM5C,cAAc,CAAC4C,UAAD,CAA3B;AACD,KAFwB,CAAzB;AAIAA,IAAAA,UAAU,CAACnC,UAAX,GAAwBA,UAAxB;AAEA,UAAM,KAAKK,OAAL,CAAa,gBAAb,EAA+B8B,UAA/B,EAA2C,YAAW;AAC1DR,MAAAA,MAAM,CAACC,IAAP,CAAYO,UAAU,CAACnC,UAAvB,EAAmCwB,OAAnC,CAA2CjB,IAAI,IAAI,KAAKO,cAAL,CAAoBP,IAApB,EAA0B4B,UAAU,CAACnC,UAAX,CAAsBO,IAAtB,CAA1B,CAAnD;AACA,aAAO4B,UAAP;AACD,KAHK,CAAN;AAKA,UAAMG,OAAO,GAAG,MAAM,KAAKjC,OAAL,CAAa,cAAb,EAA6B8B,UAA7B,EAAyC,YAAY;AACzE,aAAO,MAAM9C,WAAW,CAAC8C,UAAD,CAAxB;AACD,KAFqB,CAAtB;AAIAA,IAAAA,UAAU,CAACG,OAAX,GAAqBA,OAArB;AAEA,UAAM,KAAKjC,OAAL,CAAa,aAAb,EAA4B8B,UAA5B,EAAwC,YAAW;AACvDA,MAAAA,UAAU,CAACG,OAAX,CAAmBd,OAAnB,CAA2Be,KAAK,IAAI,KAAKpB,UAAL,CAAgBoB,KAAhB,CAApC;AACA,aAAOJ,UAAP;AACD,KAHK,CAAN;AAKA,WAAOA,UAAP;AACD;;AAlIsC;;AAqIzC,SAAS1B,eAAT,CAAyB+B,iBAAzB,EAA4C;AAE1C,MAAIC,OAAO,GAAG,IAAd;AACA,SAAO,SAASC,eAAT,CAAyBC,GAAzB,EAA8BC,GAA9B,EAAmCC,IAAnC,EAAyC;AAC9C,QAAIJ,OAAJ,EAAanD,MAAM,CAACyC,IAAP,CAAY,0DAA0DY,GAAG,CAACG,GAA1E;AACbN,IAAAA,iBAAiB,CAACO,IAAlB,CAAuBC,iBAAiB,IAAI;AAC1CP,MAAAA,OAAO,GAAG,KAAV;AACAO,MAAAA,iBAAiB,CAACL,GAAD,EAAMC,GAAN,EAAWC,IAAX,CAAjB;AACD,KAHD,EAGGhC,KAHH,CAGUoC,CAAD,IAAO;AACd,YAAMA,CAAN;AACD,KALD;AAMD,GARD;AASD;;AAEDC,MAAM,CAACC,OAAP,GAAiBvD,YAAjB","sourcesContent":["const config = require('boring-config');\r\nconst express = require('express');\r\nconst initRouters = require('./init-routers');\r\nconst logger = require('boring-logger');\r\nconst initMiddleware = require('./init-middleware');\r\nconst initHooks = require('./init-hooks');\r\nconst EventEmitter = require('eventemitter2');\r\nconst paths = require('paths');\r\nconst Understudy = require('boring-understudy');\r\n\r\nclass InitPipeline extends EventEmitter  {\r\n\r\n  constructor() {\r\n    super({wildcard: true});\r\n    Understudy.call(this);\r\n    this.config = config;\r\n    this.logger = logger;\r\n    this.paths = paths;\r\n\r\n    this.middleware = {};\r\n    this.hooks = {};\r\n    this.app = express();\r\n\r\n    this.app.oldUse = this.app.use;\r\n    const perform = this.perform.bind(this);\r\n\r\n    this.app.use = (name, middleware) => {\r\n\r\n      if (typeof name === 'function') {\r\n        middleware = name;\r\n        name = middleware.name; // just use the name of the function\r\n      }\r\n\r\n\r\n      let ctx = {\r\n        middleware,\r\n        name\r\n      }\r\n\r\n      // this.app.oldUse(middleware);\r\n\r\n      this.app.oldUse(deferMiddleware(new Promise(function(resolve, reject) {\r\n\r\n        perform('app.use', ctx, async function() {\r\n          // This in a way acts a dependency  \r\n          // system where a hook can only \r\n          // effectively call app.use AFTER or \r\n          // before a dependency.  \r\n          //\r\n          // In theory this has the danger of \r\n          // creating a cycle.  Maybe in the \r\n          // future we can avoid that \r\n          resolve(ctx.middleware);\r\n          return ctx;\r\n        }).catch(reject);\r\n\r\n      })))\r\n     \r\n     }\r\n  }\r\n\r\n  add_middleware(name, middleware) {\r\n    if (this.middleware[name]) throw new Error('Cannot add middleware with the same key as '+ name)\r\n    this.middleware[name] = middleware;\r\n    this.emit('added.middleware', name, middleware);\r\n  }\r\n\r\n  add_hook(name, hook) {\r\n    if (this.hooks[name]) throw new Error('Cannot add hook with the same key as '+ name)\r\n    this.hooks[name] = hook;\r\n    this.emit('added.hook', name, hook);\r\n  }\r\n\r\n  add_router(router) {\r\n\r\n    const routePath = router.path || '';\r\n    const app = this.app;\r\n\r\n    router.endpoints.forEach((endpoint = {path: '', methods: {}}) => {\r\n        \r\n      // don't blow up if there are no methods\r\n      const methods = endpoint.methods || {};\r\n      Object.keys(methods).forEach(method => {\r\n        let path = routePath + endpoint.path;\r\n        let handler = endpoint.methods[method];\r\n        // this IF checks to see\r\n        // if handler is an object rather\r\n        // than a function \r\n        if (handler.handler) handler = handler.handler\r\n    \r\n        app[method](path, handler);\r\n        logger.info(`Installed {${method.toUpperCase()}} for path ${path}`); \r\n      });\r\n      \r\n      this.emit('added.endpoint', endpoint);\r\n    })\r\n\r\n  }\r\n\r\n  async build(options) {\r\n\r\n    let injections = Object.assign({}, {\r\n      boring: this\r\n    }, options);\r\n\r\n    \r\n    const hooks = await this.perform('init-hooks', injections, async () => {\r\n      return await initHooks(injections);\r\n    })\r\n\r\n    injections.hooks = hooks;\r\n\r\n    await this.perform('add-hooks', injections, async() => {\r\n      Object.keys(injections.hooks).forEach(name => this.add_hook(name, injections.hooks[name]));\r\n      return injections;\r\n    })\r\n\r\n    const middleware = await this.perform('init-middleware', injections, async () => {\r\n      return await initMiddleware(injections);\r\n    })\r\n\r\n    injections.middleware = middleware;\r\n\r\n    await this.perform('add-middleware', injections, async() => {\r\n      Object.keys(injections.middleware).forEach(name => this.add_middleware(name, injections.middleware[name]));\r\n      return injections;\r\n    })\r\n  \r\n    const routers = await this.perform('init-routers', injections, async () => {\r\n      return await initRouters(injections);\r\n    })\r\n\r\n    injections.routers = routers;\r\n\r\n    await this.perform('add-routers', injections, async() => {\r\n      injections.routers.forEach(route => this.add_router(route));\r\n      return injections;\r\n    })\r\n\r\n    return injections;\r\n  }\r\n}\r\n\r\nfunction deferMiddleware(middlewarePromise) {\r\n\r\n  let queuing = true;\r\n  return function proxyMiddleware(req, res, next) {\r\n    if (queuing) logger.info('App use has not finished loading middleware, queuing ' + req.url);\r\n    middlewarePromise.then(deferedMiddleware => {\r\n      queuing = false;\r\n      deferedMiddleware(req, res, next);\r\n    }).catch((e) => {\r\n      throw e;\r\n    })\r\n  }\r\n}\r\n\r\nmodule.exports = InitPipeline;"],"file":"init-pipeline.js"}