{"version":3,"sources":["../../src/lib/init-pipeline.js"],"names":["config","require","express","initRouters","logger","initMiddleware","initHooks","EventEmitter","paths","Understudy","decorators","InitPipeline","constructor","wildcard","call","middleware","hooks","app","oldUse","use","perform","bind","name","ctx","deferMiddleware","Promise","resolve","reject","catch","add_middleware","Error","emit","add_hook","hook","add_router","router","routePath","path","endpoints","forEach","endpoint","methods","Object","keys","method","handler","info","toUpperCase","build","options","injections","assign","boring","routers","route","middlewarePromise","queuing","proxyMiddleware","req","res","next","url","then","deferedMiddleware","e","module","exports"],"mappings":"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","sourcesContent":["const config = require('boring-config');\nconst express = require('express');\nconst initRouters = require('./init-routers');\nconst logger = require('boring-logger');\nconst initMiddleware = require('./init-middleware');\nconst initHooks = require('./init-hooks');\nconst EventEmitter = require('eventemitter2');\nconst paths = require('paths');\nconst Understudy = require('boring-understudy');\nconst decorators = require('./decorators')\n\n\nclass InitPipeline extends EventEmitter  {\n\n  constructor() {\n    super({wildcard: true});\n    Understudy.call(this);\n    this.config = config;\n    this.logger = logger;\n    this.paths = paths;\n\n    this.middleware = {};\n    this.hooks = {};\n    this.app = express();\n    this.decorators = decorators;\n\n    this.app.oldUse = this.app.use;\n    const perform = this.perform.bind(this);\n\n    this.app.use = (name, middleware) => {\n\n      if (typeof name === 'function') {\n        middleware = name;\n        name = middleware.name; // just use the name of the function\n      }\n\n\n      let ctx = {\n        middleware,\n        name\n      }\n\n      // this.app.oldUse(middleware);\n\n      this.app.oldUse(deferMiddleware(new Promise(function(resolve, reject) {\n\n        perform('app.use', ctx, async function() {\n          // This in a way acts a dependency  \n          // system where a hook can only \n          // effectively call app.use AFTER or \n          // before a dependency.  \n          //\n          // In theory this has the danger of \n          // creating a cycle.  Maybe in the \n          // future we can avoid that \n          resolve(ctx.middleware);\n          return ctx;\n        }).catch(reject);\n\n      })))\n     \n     }\n  }\n\n  add_middleware(name, middleware) {\n    if (this.middleware[name]) throw new Error('Cannot add middleware with the same key as '+ name)\n    this.middleware[name] = middleware;\n    this.emit('added.middleware', name, middleware);\n  }\n\n  add_hook(name, hook) {\n    if (this.hooks[name]) throw new Error('Cannot add hook with the same key as '+ name)\n    this.hooks[name] = hook;\n    this.emit('added.hook', name, hook);\n  }\n\n  add_router(router) {\n\n    const routePath = router.path || '';\n    const app = this.app;\n\n    router.endpoints.forEach((endpoint = {path: '', methods: {}}) => {\n        \n      // don't blow up if there are no methods\n      const methods = endpoint.methods || {};\n      Object.keys(methods).forEach(method => {\n        let path = routePath + endpoint.path;\n        let handler = endpoint.methods[method];\n        // this IF checks to see\n        // if handler is an object rather\n        // than a function \n        if (handler.handler) handler = handler.handler\n    \n        app[method](path, handler);\n        logger.info(`Installed {${method.toUpperCase()}} for path ${path}`); \n      });\n      \n      this.emit('added.endpoint', endpoint);\n    })\n\n  }\n\n  async build(options) {\n\n    let injections = Object.assign({}, {\n      boring: this\n    }, options);\n    \n    const hooks = await this.perform('init-hooks', injections, async () => {\n      return await initHooks(injections);\n    })\n\n    injections.hooks = hooks;\n\n    await this.perform('add-hooks', injections, async() => {\n      Object.keys(injections.hooks).forEach(name => this.add_hook(name, injections.hooks[name]));\n      return injections;\n    })\n\n    const middleware = await this.perform('init-middleware', injections, async () => {\n      return await initMiddleware(injections);\n    })\n\n    injections.middleware = middleware;\n\n    await this.perform('add-middleware', injections, async() => {\n      Object.keys(injections.middleware).forEach(name => this.add_middleware(name, injections.middleware[name]));\n      return injections;\n    })\n  \n    const routers = await this.perform('init-routers', injections, async () => {\n      return await initRouters(injections);\n    })\n\n    injections.routers = routers;\n\n    await this.perform('add-routers', injections, async() => {\n      injections.routers.forEach(route => this.add_router(route));\n      return injections;\n    })\n\n    return injections;\n  }\n}\n\nfunction deferMiddleware(middlewarePromise) {\n\n  let queuing = true;\n  return function proxyMiddleware(req, res, next) {\n    if (queuing) logger.info('App use has not finished loading middleware, queuing ' + req.url);\n    middlewarePromise.then(deferedMiddleware => {\n      queuing = false;\n      deferedMiddleware(req, res, next);\n    }).catch((e) => {\n      throw e;\n    })\n  }\n}\n\nmodule.exports = InitPipeline;"],"file":"init-pipeline.js"}