{"version":3,"sources":["../../../../../src/lib/init-hooks/core-hooks/react/index.js"],"names":["Layout","require","decorators","config","paths","renderRedux","dynamicComponents","default","fs","module","exports","reactHook","BoringInjections","boring","router","createEndpointDecorator","shadowedReactEntry","reactEntry","shadowedEntrypoint","options","reactRoot","createDecorator","target","field","descriptor","toLowerCase","clientRoot","get","baseAppPath","entrypointFile","routeContainersDirectory","mainAppFile","reducersFile","reactHandlerPaths","entrypoint","mainApp","reducers","routerContainers","containers","getContainers","modulesToRequire","entryPointPath","app_dir","existsSync","__dirname","beforeEntry","afterEntry","entrypointPaths","filter","Boolean","before","ctx","res","reactPaths","Promise","resolve","react","name","containersDirPath","readdirSync","map","file","endsWith","moduleName","split","shift","container","path","importPath","e"],"mappings":"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","sourcesContent":["const Layout = require('./Layout');\nconst decorators = require('../../../decorators');\nconst config = require('boring-config');\nconst paths = require('paths');\nconst renderRedux = require('./renderRedux');\nconst dynamicComponents = require('./dynamicComponents').default;\nconst fs = require('fs');\n\nmodule.exports = function reactHook(BoringInjections) {\n  const {\n    boring,\n  } = BoringInjections;\n\n  decorators.router.createEndpointDecorator('reactEntry', 'get');\n\n  const shadowedReactEntry = decorators.router.reactEntry;\n  decorators.router.reactEntry = function shadowedEntrypoint(options = {}) {\n\n    if (typeof options === 'string') {\n      options = {reactRoot: options};\n    }\n\n    return function createDecorator(target, field, descriptor) {\n\n      if (!options.reactRoot) {\n        // if there is nothing passed into the decorator\n        // assume the the function name that is decorating\n        // is the name of the page in client.\n        //\n        // @reactEntry()\n        // helloworld(req, res) { res.renderRedux(); }\n        //\n        // Would end up mapping to {app_root}/client/pages/helloworld/entrypoint.js\n        options.reactRoot = field.toLowerCase();\n      }\n\n      // this needs to live outside of the spread\n      // because it is used to create baseAppPath\n      const clientRoot = options.clientRoot || config.get('boring.react.clientRoot', 'client/pages');\n\n      options = {\n        ...paths,\n        clientRoot,\n        baseAppPath: clientRoot + '/' + options.reactRoot,\n        entrypointFile: config.get('boring.react.entrypoint', 'entrypoint'),\n        routeContainersDirectory: config.get('boring.react.routerContainersDirectory', 'containers'),\n        // not quite sure if we are gonna require this for people.\n        mainAppFile: config.get('boring.react.mainApp', 'App.js'),\n        reducersFile: config.get('boring.react.reducers', 'reducers'),\n        ...options,\n      };\n\n      const reactHandlerPaths = {\n        // This grouping are filepaths\n        // relative to the application\n        // meant to be required / imported.\n        // These are the `defaults` for borings\n        // react / redux conventions\n        entrypoint: options.baseAppPath + '/' + options.entrypointFile,\n        mainApp: options.baseAppPath + '/'+ options.mainAppFile,\n        reducers: options.baseAppPath + '/'+ options.reducersFile,\n        // this one is a little special, we want to\n        // make sure it's relative to the app_dir\n        // but not having the app_dir in it's path\n        routerContainers: options.baseAppPath + '/' + options.routeContainersDirectory,\n        ...options,\n      };\n\n      reactHandlerPaths.containers = getContainers(reactHandlerPaths);\n\n      const modulesToRequire = {};\n      const entryPointPath = options.app_dir +'/'+reactHandlerPaths.entrypoint;\n      \n      // check to make sure entrypoint is real\n      if (!fs.existsSync(entryPointPath + '.js') &&\n        !fs.existsSync(entryPointPath + '.jsx') &&\n        !fs.existsSync(entryPointPath + '.ts') &&\n        !fs.existsSync(entryPointPath + '.tsx')) {\n        reactHandlerPaths.entrypoint = __dirname + '/defaultEntrypoint.js';\n        modulesToRequire['reducers'] = reactHandlerPaths.reducers;\n        modulesToRequire['mainApp'] = reactHandlerPaths.mainApp;\n      }\n\n      const [beforeEntry, afterEntry] = dynamicComponents(reactHandlerPaths, modulesToRequire);\n\n      const entrypointPaths = [\n        beforeEntry,\n        reactHandlerPaths.entrypoint,\n        afterEntry,\n      ].filter(Boolean);\n\n      return decorators.router.entrypoint(...entrypointPaths)(\n          target,\n          field,\n          shadowedReactEntry(reactHandlerPaths)(target, field, descriptor)\n      );\n    };\n  };\n\n  boring.before('http::get', function(ctx) {\n    if (ctx.get.reactEntry) {\n      ctx.res.reactPaths = ctx.get.reactEntry[0];\n      ctx.res.renderRedux = renderRedux;\n    }\n\n\n    return Promise.resolve();\n  });\n\n\n  boring.react = {\n    Layout,\n  };\n\n  return {name: 'react'};\n};\n\n\nfunction getContainers(reactHandlerPaths) {\n  const containersDirPath = reactHandlerPaths.app_dir +'/'+ reactHandlerPaths.routerContainers;\n  try {\n    return fs.readdirSync(containersDirPath).map(function(file) {\n      if (file.endsWith('.map')) return null;\n      const moduleName = file.split('.').shift(); // don't worry about what type of extension\n      const container = require(containersDirPath + '/' + moduleName).default;\n      return {\n        path: container.path,\n        container,\n        moduleName,\n        importPath: reactHandlerPaths.routerContainers + '/' + moduleName,\n      };\n    }).filter(Boolean);\n  } catch (e) {\n    return [];\n  }\n}\n"],"file":"index.js"}