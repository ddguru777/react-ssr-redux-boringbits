{"version":3,"sources":["../../../../../src/lib/init-hooks/core-hooks/webpack-dev/createWebpackStack.js"],"names":["compose","require","config","logger","pathitize","passthrough","req","res","next","deferMiddleware","middlewarePromise","queuing","proxyMiddleware","info","url","then","deferedMiddleware","module","exports","createWebpackStack","BoringInjections","boring","webpack_config","webpackDevPromise","Promise","resolve","reject","before","routers","entry","reduce","collector","router","endpoints","forEach","endpoint","methods","Object","keys","method","methodObj","entrypoint","entrypoints","get","unshift","webpack","compiler","webpackDevMiddleware","serverSideRender","publicPath","HMRMiddleware"],"mappings":"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","sourcesContent":["const compose = require('compose-middleware').compose\r\nconst config = require('boring-config');\r\nconst logger = require('boring-logger');\r\nconst pathitize = require('./pathitize');\r\n\r\nfunction passthrough(req, res, next) { next() }\r\n\r\nfunction deferMiddleware(middlewarePromise) {\r\n\r\n  let queuing = true;\r\n  return function proxyMiddleware(req, res, next) {\r\n    if (queuing) logger.info('Webpack has not finished loading, queuing ' + req.url);\r\n    middlewarePromise.then(deferedMiddleware => {\r\n      queuing = false;\r\n      deferedMiddleware(req, res, next);\r\n    });\r\n  }\r\n}\r\n\r\nmodule.exports = function createWebpackStack(BoringInjections) {\r\n\r\n  const {\r\n    boring,\r\n    webpack_config\r\n  } = BoringInjections;\r\n\r\n\r\n  const webpackDevPromise = new Promise((resolve, reject) => {\r\n\r\n    /**\r\n     * We cannot build the webpack middleware because\r\n     * there is no information on the entrypoints on each endpoint.  \r\n     * \r\n     * Let's wait until AFTER the routes are init'd, but before they are added\r\n     * to boring.  Then we will collect all the entry points to \r\n     * finalize the webpack config\r\n     */\r\n    boring.before('add-routers', function({routers}) {\r\n\r\n      webpack_config.entry = routers.reduce((collector, router) => {\r\n        if (!router.endpoints) return;\r\n        router.endpoints.forEach(endpoint => {\r\n          if (!endpoint.methods) return;\r\n          Object.keys(endpoint.methods).forEach(method => {\r\n            const methodObj = endpoint.methods[method];\r\n            if (methodObj.entrypoint) {\r\n              const entrypoints = ['@babel/polyfill', methodObj.entrypoint];\r\n              if (config.get('boring.use_webpack_dev_server')) {\r\n                entrypoints.unshift(\"webpack-hot-middleware/client?path=/__webpack_hmr&timeout=20000\");\r\n              }\r\n\r\n              collector[pathitize(methodObj.entrypoint)] = entrypoints;\r\n            }\r\n          })\r\n        })\r\n        return collector\r\n      }, {});\r\n\r\n      if (config.get('boring.use_webpack_dev_server')) {\r\n        \r\n        const webpack = require('webpack')\r\n        const compiler = webpack(webpack_config)\r\n\r\n        const webpackDevMiddleware = require('webpack-dev-middleware')(compiler, {\r\n          serverSideRender: true, \r\n          publicPath: '/' \r\n        });\r\n    \r\n        const HMRMiddleware = require('webpack-hot-middleware')(compiler);\r\n\r\n        resolve(compose([\r\n          webpackDevMiddleware,\r\n          HMRMiddleware, \r\n          function(req, res, next) {\r\n            next();\r\n          }\r\n        ]));\r\n      }\r\n      else resolve(passthrough);\r\n    });\r\n\r\n  });\r\n  \r\n  return deferMiddleware(webpackDevPromise);\r\n\r\n}"],"file":"createWebpackStack.js"}