{"version":3,"sources":["../../../../../src/lib/init-hooks/core-hooks/webpack-dev/createWebpackStack.js"],"names":["compose","require","config","logger","pathitize","webpackDevMiddleware","webpackHotMiddleware","passthrough","req","res","next","deferMiddleware","middlewarePromise","queuing","proxyMiddleware","info","url","then","deferedMiddleware","module","exports","createWebpackStack","BoringInjections","boring","webpack_config","webpackDevPromise","Promise","resolve","reject","before","routers","entry","reduce","collector","router","endpoints","forEach","endpoint","methods","Object","keys","method","methodObj","entrypoint","entrypoints","concat","get","unshift","webpack","compiler","serverSideRender","publicPath"],"mappings":";;AAAA,MAAMA,OAAO,GAAGC,OAAO,CAAC,oBAAD,CAAP,CAA8BD,OAA9C;;AACA,MAAME,MAAM,GAAGD,OAAO,CAAC,eAAD,CAAtB;;AACA,MAAME,MAAM,GAAGF,OAAO,CAAC,eAAD,CAAtB;;AACA,MAAMG,SAAS,GAAGH,OAAO,CAAC,aAAD,CAAzB;;AACA,MAAMI,oBAAoB,GAAGJ,OAAO,CAAC,wBAAD,CAApC;;AACA,MAAMK,oBAAoB,GAAGL,OAAO,CAAC,wBAAD,CAApC;;AAEA,SAASM,WAAT,CAAqBC,GAArB,EAA0BC,GAA1B,EAA+BC,IAA/B,EAAqC;AACnCA,EAAAA,IAAI;AACL;;AAED,SAASC,eAAT,CAAyBC,iBAAzB,EAA4C;AAC1C,MAAIC,OAAO,GAAG,IAAd;AACA,SAAO,SAASC,eAAT,CAAyBN,GAAzB,EAA8BC,GAA9B,EAAmCC,IAAnC,EAAyC;AAC9C,QAAIG,OAAJ,EAAaV,MAAM,CAACY,IAAP,CAAY,+CAA+CP,GAAG,CAACQ,GAA/D;AACbJ,IAAAA,iBAAiB,CAACK,IAAlB,CAAuBC,iBAAiB,IAAI;AAC1CL,MAAAA,OAAO,GAAG,KAAV;AACAK,MAAAA,iBAAiB,CAACV,GAAD,EAAMC,GAAN,EAAWC,IAAX,CAAjB;AACD,KAHD;AAID,GAND;AAOD;;AAEDS,MAAM,CAACC,OAAP,GAAiB,SAASC,kBAAT,CAA4BC,gBAA5B,EAA8C;AAC7D,QAAM;AACJC,IAAAA,MADI;AAEJ;AACAC,IAAAA;AAHI,MAIFF,gBAJJ;AAOA,QAAMG,iBAAiB,GAAG,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACzD;;;;;;;;AAQAL,IAAAA,MAAM,CAACM,MAAP,CAAc,aAAd,EAA6B,UAAS;AAACC,MAAAA;AAAD,KAAT,EAAoB;AAC/CN,MAAAA,cAAc,CAACO,KAAf,GAAuBD,OAAO,CAACE,MAAR,CAAe,CAACC,SAAD,EAAYC,MAAZ,KAAuB;AAC3D,YAAI,CAACA,MAAM,CAACC,SAAZ,EAAuB;AACvBD,QAAAA,MAAM,CAACC,SAAP,CAAiBC,OAAjB,CAAyBC,QAAQ,IAAI;AACnC,cAAI,CAACA,QAAQ,CAACC,OAAd,EAAuB;AACvBC,UAAAA,MAAM,CAACC,IAAP,CAAYH,QAAQ,CAACC,OAArB,EAA8BF,OAA9B,CAAsCK,MAAM,IAAI;AAC9C,kBAAMC,SAAS,GAAGL,QAAQ,CAACC,OAAT,CAAiBG,MAAjB,CAAlB;;AACA,gBAAIC,SAAS,CAACC,UAAd,EAA0B;AACxB,oBAAMC,WAAW,GAAG,CAAC,iBAAD,EAAoBC,MAApB,CAA2BH,SAAS,CAACC,UAArC,CAApB;;AACA,kBAAIzC,MAAM,CAAC4C,GAAP,CAAW,+BAAX,CAAJ,EAAiD;AAC/CF,gBAAAA,WAAW,CAACG,OAAZ,CAAoB,iEAApB;AACD;;AAEDd,cAAAA,SAAS,CAAC7B,SAAS,CAACsC,SAAS,CAACC,UAAX,CAAV,CAAT,GAA6CC,WAA7C;AACD;AACF,WAVD;AAWD,SAbD;AAeA,eAAOX,SAAP;AACD,OAlBsB,EAkBpB,EAlBoB,CAAvB;;AAqBA,UAAI/B,MAAM,CAAC4C,GAAP,CAAW,+BAAX,CAAJ,EAAiD;AAC/C,cAAME,OAAO,GAAG/C,OAAO,CAAC,SAAD,CAAvB;;AACA,cAAMgD,QAAQ,GAAGD,OAAO,CAACxB,cAAD,CAAxB;AAEAG,QAAAA,OAAO,CAAC3B,OAAO,CAAC,CACdK,oBAAoB,CAAC4C,QAAD,EAAW;AAC7BC,UAAAA,gBAAgB,EAAE,IADW;AAE7BC,UAAAA,UAAU,EAAE;AAFiB,SAAX,CADN,EAKd7C,oBAAoB,CAAC2C,QAAD,CALN,CAAD,CAAR,CAAP;AAOD,OAXD,MAWOtB,OAAO,CAACpB,WAAD,CAAP;AACR,KAlCD;AAmCD,GA5CyB,CAA1B;AA8CA,SAAOI,eAAe,CAACc,iBAAD,CAAtB;AACD,CAvDD","sourcesContent":["const compose = require('compose-middleware').compose;\nconst config = require('boring-config');\nconst logger = require('boring-logger');\nconst pathitize = require('./pathitize');\nconst webpackDevMiddleware = require('webpack-dev-middleware');\nconst webpackHotMiddleware = require('webpack-hot-middleware');\n\nfunction passthrough(req, res, next) {\n  next();\n}\n\nfunction deferMiddleware(middlewarePromise) {\n  let queuing = true;\n  return function proxyMiddleware(req, res, next) {\n    if (queuing) logger.info('Webpack has not finished loading, queuing ' + req.url);\n    middlewarePromise.then(deferedMiddleware => {\n      queuing = false;\n      deferedMiddleware(req, res, next);\n    });\n  };\n}\n\nmodule.exports = function createWebpackStack(BoringInjections) {\n  const {\n    boring,\n    // eslint-disable-next-line camelcase\n    webpack_config,\n  } = BoringInjections;\n\n\n  const webpackDevPromise = new Promise((resolve, reject) => {\n    /**\n     * We cannot build the webpack middleware because\n     * there is no information on the entrypoints on each endpoint.\n     *\n     * Let's wait until AFTER the routes are init'd, but before they are added\n     * to boring.  Then we will collect all the entry points to\n     * finalize the webpack config\n     */\n    boring.before('add-routers', function({routers}) {\n      webpack_config.entry = routers.reduce((collector, router) => {\n        if (!router.endpoints) return;\n        router.endpoints.forEach(endpoint => {\n          if (!endpoint.methods) return;\n          Object.keys(endpoint.methods).forEach(method => {\n            const methodObj = endpoint.methods[method];\n            if (methodObj.entrypoint) {\n              const entrypoints = ['@babel/polyfill'].concat(methodObj.entrypoint);\n              if (config.get('boring.use_webpack_dev_server')) {\n                entrypoints.unshift('webpack-hot-middleware/client?path=/__webpack_hmr&timeout=20000');\n              }\n\n              collector[pathitize(methodObj.entrypoint)] = entrypoints;\n            }\n          });\n        });\n\n        return collector;\n      }, {});\n\n\n      if (config.get('boring.use_webpack_dev_server')) {\n        const webpack = require('webpack');\n        const compiler = webpack(webpack_config);\n\n        resolve(compose([\n          webpackDevMiddleware(compiler, {\n            serverSideRender: true,\n            publicPath: '/',\n          }),\n          webpackHotMiddleware(compiler),\n        ]));\n      } else resolve(passthrough);\n    });\n  });\n\n  return deferMiddleware(webpackDevPromise);\n};\n"],"file":"createWebpackStack.js"}