{"version":3,"sources":["../../../../../src/lib/init-hooks/core-hooks/webpack-dev/staticInjectionMiddleware.js"],"names":["logger","require","paths","pathitize","manifestAssets","assetsByManifest","manifestPath","asset_manifest","manifest","info","js","Object","keys","reduce","collector","name","assets","concat","filter","asset","endsWith","length","split","shift","css","assetsByDevserver","webpackStats","chunks","toJson","assetsByChunkName","chunk","module","exports","getStaticInjections","res","entrypoint","locals","asset_key","js_files","css_files","js_injections","map","css_injections"],"mappings":"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","sourcesContent":["const logger = require('boring-logger');\nconst paths = require('paths');\nconst pathitize = require('./pathitize');\n\nlet manifestAssets;\n\nfunction assetsByManifest() {\n  if (manifestAssets) return manifestAssets;\n  const manifestPath = paths.asset_manifest;\n  const manifest = require(manifestPath);\n  logger.info(manifest, `Manifest loaded from path ${  manifestPath}`);\n\n  const js = Object.keys(manifest).reduce((collector, name) => {\n    const assets = [].concat(manifest[name]).filter(asset => asset.endsWith('.js'));\n    if (assets.length === 0) return collector;\n    collector[name.split('.').shift()] = assets;\n    return collector;\n  }, {});\n\n  const css = Object.keys(manifest).reduce((collector, name) => {\n    const assets = [].concat(manifest[name]).filter(asset => asset.endsWith('.css'));\n    if (assets.length === 0) return collector;\n    collector[name.split('.').shift()] = assets;\n    return collector;\n  }, {});\n\n  manifestAssets = {\n    js,\n    css,\n  };\n\n  return manifestAssets;\n}\n\nfunction assetsByDevserver(webpackStats) {\n  const chunks = webpackStats.toJson().assetsByChunkName;\n\n  const js = Object.keys(chunks).reduce((collector, name) => {\n    const assets = chunks[name].filter(chunk => chunk.endsWith('.js'));\n    if (assets.length === 0) return collector;\n    collector[name.split('.').shift()] = assets;\n    return collector;\n  }, {});\n\n  const css = Object.keys(chunks).reduce((collector, name) => {\n    const assets = chunks[name].filter(chunk => chunk.endsWith('.css'));\n    if (assets.length === 0) return collector;\n    collector[name.split('.').shift()] = assets;\n    return collector;\n  }, {});\n\n  return {\n    js,\n    css,\n  };\n}\n\nmodule.exports = function getStaticInjections(res, entrypoint) {\n  const assets = (res.locals.webpackStats) ? assetsByDevserver(res.locals.webpackStats) : assetsByManifest();\n  const asset_key = pathitize(entrypoint);\n\n  const js_files = assets.js[asset_key] || [];\n  const css_files = assets.css[asset_key] || [];\n\n  res.locals.js_injections = js_files.map((asset) => {\n    if (asset[0] !== '/') asset = `/${asset}`;\n    return `\\n<script async=\"true\" src=\"${asset}\"></script>`;\n  });\n\n  res.locals.css_injections = css_files.map((asset) => {\n    if (asset[0] !== '/') asset = `/${asset}`;\n    return `\\n<link rel=\"stylesheet\" href=\"${asset}\"></link>`;\n  });\n};\n"],"file":"staticInjectionMiddleware.js"}