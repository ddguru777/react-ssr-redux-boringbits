{"version":3,"sources":["../../../../../src/lib/init-hooks/core-hooks/webpack-dev/staticInjectionMiddleware.js"],"names":["logger","require","paths","pathitize","manifestAssets","assetsByManifest","manifestPath","asset_manifest","manifest","info","js","Object","keys","reduce","collector","name","assets","concat","filter","asset","endsWith","length","unshift","split","shift","css","assetsByDevserver","webpackStats","chunks","toJson","assetsByChunkName","chunk","runtime","module","exports","getStaticInjections","res","entrypoint","locals","assetKey","jsFiles","cssFiles","pageInjections","bodyEndScripts","headLinks","headScripts","map","async","src","rel","href"],"mappings":"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","sourcesContent":["const logger = require('boring-logger');\nconst paths = require('paths');\nconst pathitize = require('./pathitize');\n\nlet manifestAssets;\n\nfunction assetsByManifest() {\n  if (manifestAssets) return manifestAssets;\n  const manifestPath = paths.asset_manifest;\n  const manifest = require(manifestPath);\n  logger.info(manifest, `Manifest loaded from path ${manifestPath}`);\n\n  const js = Object.keys(manifest).reduce((collector, name) => {\n    const assets = [].concat(manifest[name]).filter(asset => asset.endsWith('.js'));\n    if (assets.length === 0) return collector;\n    if (manifest['runtime.js']) {\n      assets.unshift(manifest['runtime.js']);\n    }\n    collector[name.split('.').shift()] = assets;\n    return collector;\n  }, {});\n\n  const css = Object.keys(manifest).reduce((collector, name) => {\n    const assets = [].concat(manifest[name]).filter(asset => asset.endsWith('.css'));\n    if (assets.length === 0) return collector;\n    collector[name.split('.').shift()] = assets;\n    return collector;\n  }, {});\n\n  manifestAssets = {\n    js,\n    css,\n  };\n\n  return manifestAssets;\n}\n\nfunction assetsByDevserver(webpackStats) {\n  const chunks = webpackStats.toJson().assetsByChunkName;\n\n  const js = Object.keys(chunks).reduce((collector, name) => {\n    const assets = chunks[name].filter(chunk => chunk.endsWith('.js'));\n    if (assets.length === 0) return collector;\n    if (chunks.runtime) {\n      assets.unshift([].concat(chunks.runtime).filter(asset => asset.endsWith('.js')));\n    }\n    collector[name.split('.').shift()] = assets;\n    return collector;\n  }, {});\n\n  const css = Object.keys(chunks).reduce((collector, name) => {\n    const assets = chunks[name].filter(chunk => chunk.endsWith('.css'));\n    if (assets.length === 0) return collector;\n    collector[name.split('.').shift()] = assets;\n    return collector;\n  }, {});\n\n  return {\n    js,\n    css,\n  };\n}\n\nmodule.exports = function getStaticInjections(res, entrypoint) {\n  const assets = (res.locals.webpackStats) ? assetsByDevserver(res.locals.webpackStats) : assetsByManifest();\n  const assetKey = pathitize(entrypoint);\n\n  const jsFiles = assets.js[assetKey] || [];\n  const cssFiles = assets.css[assetKey] || [];\n\n  if (!res.locals.pageInjections) {\n    res.locals.pageInjections = {\n      bodyEndScripts: [],\n      headLinks: [],\n      headScripts: [],\n    };\n  } else if (!res.locals.pageInjections.bodyEndScripts) {\n    res.locals.pageInjections.bodyEndScripts = [];\n  } else if (!res.locals.pageInjections.headLinks) {\n    res.locals.pageInjections.headLinks = [];\n  } else if (!res.locals.pageInjections.headScripts) {\n    res.locals.pageInjections.headScripts = [];\n  }\n\n  res.locals.pageInjections.bodyEndScripts = res.locals.pageInjections.bodyEndScripts.concat(jsFiles.map((asset) => {\n    if (asset[0] !== '/') asset = `/${asset}`;\n    return {\n      async: true,\n      src: asset,\n    };\n  }))\n\n  res.locals.pageInjections.headLinks = res.locals.pageInjections.headLinks.concat(cssFiles.map((asset) => {\n    if (asset[0] !== '/') asset = `/${asset}`;\n    return {\n      rel: 'stylesheet',\n      href: asset,\n    };\n  }));\n};\n"],"file":"staticInjectionMiddleware.js"}