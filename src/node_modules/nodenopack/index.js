
const Module = require('module');
const getNamespace = require('boring-cls').getNamespace;
const path = require('path');
const logger = require('boring-logger');

let inited = false;
let webpackStats;

function init() {

  if (inited) return;

  const originalRequire = Module.prototype.require;
  Module.prototype.require = function() {
    // eslint-disable-next-line prefer-rest-params
    const args = Array.prototype.slice.apply(arguments);
    const fileName = (args[0]|| '').toLowerCase();

    // for css don't blow up and move on
    if (fileName.endsWith('.css')) return {};
    if (fileName.endsWith('.jpg') ||
        fileName.endsWith('.jpeg') ||
        fileName.endsWith('.png') ||
        fileName.endsWith('.gif') ||
        fileName.endsWith('.webp')) {

      const ns = getNamespace('http-request');
      const reactHandlerPaths = ns.get('reactHandlerPaths');

      if (reactHandlerPaths && Object.keys(reactHandlerPaths).length) {

        const parts = this.id.split('/');
        // get rid of the filename
        parts.pop();

        const id = '.' + path.normalize(
          parts.join('/') + '/' + fileName
        ).substring(process.cwd().length);

        if (webpackStats && webpackStats.modules) {
          const modules = webpackStats.modules.filter(module => module.id === id.replace('/dist', '/src'));

          if (modules.length === 1 && modules[0].assets.length === 1) {
            return '/' + modules.shift().assets.shift();
          } else logger.debug(modules, `Did resolve module properly for ${id}`);

        }
        // default 1 x 1 transparent gif
        return 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

      }
    }
    return originalRequire.apply(this, args);
  };

  inited = true;

}
init();

function registerWebpackStats(stats) {
  webpackStats = stats;
}

module.exports = {
  registerWebpackStats,
};
